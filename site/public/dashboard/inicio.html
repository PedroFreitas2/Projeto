<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Implementando ChartJS</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="../css/inicio.css">
</head>

<body style="display: flex;">
  <div class="dash">
    <canvas id="myChart" class="chart-container" style=" height:40vh; width:45vw; display: flex;"></canvas>
  </div>

  <div class="voto">
    <!-- <div class="fotos">
      <img src="../assets/jordania.webp" alt="">
      <img src="../assets/china.jpg" alt="">
      <img src="../assets/coliseu.jpg" alt="">
      <img src="../assets/Machu-Picchu.jpg" alt="">
      <img src="../assets/mexico.jpg" alt="">
      <img src="../assets/petra.jpg" alt="">
      <img src="../assets/riodejaneiro.png" alt="">
    </div>
     -->
    <button onclick="votar()">Registrar Voto</button>
    <input type="text" placeholder="Insira o número do seu voto">


  </div>



</body>

</html>
<script>


  const labels = [
    'Muralha da China',
    'Coliseu',
    'Cristo Redentor',
    'Machu Pichu',
    'Chichén Itzá',
    'Petra',
    'Taj Mahal',

  ];

  const data = {
    labels: labels,
    datasets: [{
      label: 'Porcentagem de votos',
      borderColor: 'white',
      backgroundColor: [
        ' rgb(61, 96, 37)',
        'rgba(88, 13, 13, 0.638)',
        'rgb(21, 146, 195)',
        'rgb(96, 94, 94)',
        'burlywood',
        'rgb(209, 128, 78)',
        'yellow'

      ],
      data: [20, 30, 40, 50, 60, 70, 80],
    }

    ]
  };



  const config = {
    type: 'polarArea',
    data: data,
    options: {}
  };


</script>

<script>

  const myChart = new Chart(
    document.getElementById('myChart'),
    config
  );



</script>

<script>
  // O gráfico é construído com três funções:
  // 1. obterDadosGrafico -> Traz dados do Banco de Dados para montar o gráfico da primeira vez
  // 2. plotarGrafico -> Monta o gráfico com os dados trazidos e exibe em tela
  // 3. atualizarGrafico -> Atualiza o gráfico, trazendo novamente dados do Banco

  // Esta função *obterDadosGrafico* busca os últimos dados inseridos em tabela de medidas.
  // para, quando carregar o gráfico da primeira vez, já trazer com vários dados.
  // A função *obterDadosGrafico* também invoca a função *plotarGrafico*

  //     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
  //     Para ajustar o "select", ajuste o comando sql em src/models
  function obterDadosGrafico(idpaisvoto) {

    alterarTitulo(idpaisvoto)

    if (proximaAtualizacao != undefined) {
      clearTimeout(proximaAtualizacao);
    }

    fetch(`/medidas/ultimas/${idpaisvoto}`, { cache: 'no-store' }).then(function (response) {
      if (response.ok) {
        response.json().then(function (resposta) {
          console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
          resposta.reverse();

          plotarGrafico(resposta, idpaisvoto);

        });
      } else {
        console.error('Nenhum dado encontrado ou erro na API');
      }
    })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });
  }

  // Esta função *plotarGrafico* usa os dados capturados na função anterior para criar o gráfico
  // Configura o gráfico (cores, tipo, etc), materializa-o na página e, 
  // A função *plotarGrafico* também invoca a função *atualizarGrafico*
  function plotarGrafico(resposta, idpaisvoto) {

    console.log('iniciando plotagem do gráfico...');

    // Criando estrutura para plotar gráfico - labels
    let labels = [];

    // Criando estrutura para plotar gráfico - dados
    let dados = {
      labels: labels,
      datasets: [{
        label: 'Umidade',
        data: [],
        fill: false,
        borderColor: 'rgb(75, 192, 192)',
        tension: 0.1
      },
      {
        label: 'Temperatura',
        data: [],
        fill: false,
        borderColor: 'rgb(199, 52, 52)',
        tension: 0.1
      }]
    };

    console.log('----------------------------------------------')
    console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
    console.log(resposta)

    // Inserindo valores recebidos em estrutura para plotar o gráfico
    for (i = 0; i < resposta.length; i++) {
      var registro = resposta[i];
      labels.push(registro.momento_grafico);
      dados.datasets[0].data.push(registro.umidade);
      dados.datasets[1].data.push(registro.temperatura);
    }

    console.log('----------------------------------------------')
    console.log('O gráfico será plotado com os respectivos valores:')
    console.log('Labels:')
    console.log(labels)
    console.log('Dados:')
    console.log(dados.datasets)
    console.log('----------------------------------------------')

    // Criando estrutura para plotar gráfico - config
    // const config = {
    //   type: 'line',
    //   data: dados,
    // };

    const config = {
    type: 'polarArea',
    data: data,
    options: {}
  };

    // Adicionando gráfico criado em div na tela
    let myChart = new Chart(
      document.getElementById(`myChartCanvas${idpaisvoto}`),
      config
    );

    setTimeout(() => atualizarGrafico(idpaisvoto, dados, myChart), 2000);
  }


 
 
</script>